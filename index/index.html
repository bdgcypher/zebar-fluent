
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" type="text/css" href="./styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script
      src="https://unpkg.com/@babel/standalone@7.25.6/babel.min.js"
      crossorigin="anonymous"
    ></script>
  </head>

  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect } from "https://esm.sh/react@18?dev";
      import { createRoot } from "https://esm.sh/react-dom@18/client?dev";
      import * as zebar from "https://esm.sh/zebar@2";

      /* -------------------------------
         PROVIDERS
      --------------------------------*/
      const providers = zebar.createProviderGroup({
        network: { type: "network" },
        glazewm: { type: "glazewm" },
        cpu: { type: "cpu" },
        date: { type: "date", formatting: "cccc dd.MM.yyyy | t" }, // unused now
        battery: { type: "battery" },
        memory: { type: "memory" },
        weather: { type: "weather" },
      });

      /* -------------------------------
         TIME / DATE TOGGLE WIDGET
      --------------------------------*/
      function TimeWidget() {
        const [now, setNow] = useState(new Date());
        const [showDate, setShowDate] = useState(false);

        useEffect(() => {
          const interval = setInterval(() => setNow(new Date()), 1000);
          return () => clearInterval(interval);
        }, []);

        const toggle = () => setShowDate((prev) => !prev);

        // Register Alt+Shift+C
        useEffect(() => {
          const handler = (e) => {
            if (e.altKey && e.shiftKey && e.code === "KeyC") {
              toggle();
            }
          };
          window.addEventListener("keydown", handler);
          return () => window.removeEventListener("keydown", handler);
        }, []);

        const formatTime = (d) =>
          d.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });

        const formatDay = (d) =>
          d.toLocaleDateString([], { weekday: "long" });

        const formatDate = (d) =>
          d.toLocaleDateString([], {
            year: "numeric",
            month: "long",
            day: "numeric",
          });

        return (
          <div
            className="time-widget"
            onClick={toggle}
            style={{ cursor: "pointer", padding: "0 10px" }}
          >
            {showDate ? formatDate(now) : `${formatDay(now)} ${formatTime(now)}`}
          </div>
        );
      }

      /* -------------------------------
         MAIN APP
      --------------------------------*/
      function App() {
        const [output, setOutput] = useState(providers.outputMap);

        useEffect(() => {
          providers.onOutput(() => setOutput(providers.outputMap));
        }, []);

        function getNetworkIcon(networkOutput) {
          switch (networkOutput.defaultInterface?.type) {
            case "ethernet":
              return <i className="nf nf-md-ethernet_cable"></i>;
            case "wifi":
              const s = networkOutput.defaultGateway?.signalStrength;
              if (s >= 80) return <i className="nf nf-md-wifi_strength_4"></i>;
              if (s >= 65) return <i className="nf nf-md-wifi_strength_3"></i>;
              if (s >= 40) return <i className="nf nf-md-wifi_strength_2"></i>;
              if (s >= 25) return <i className="nf nf-md-wifi_strength_1"></i>;
              return <i className="nf nf-md-wifi_strength_outline"></i>;
            default:
              return <i className="nf nf-md-wifi_strength_off_outline"></i>;
          }
        }

        function getBatteryIcon(b) {
          if (b.chargePercent > 90) return <i className="nf nf-fa-battery_4"></i>;
          if (b.chargePercent > 70) return <i className="nf nf-fa-battery_3"></i>;
          if (b.chargePercent > 40) return <i className="nf nf-fa-battery_2"></i>;
          if (b.chargePercent > 20) return <i className="nf nf-fa-battery_1"></i>;
          return <i className="nf nf-fa-battery_0"></i>;
        }

        function getWeatherIcon(w) {
          switch (w.status) {
            case "clear_day": return <i className="fas fa-sun"></i>;
            case "clear_night": return <i className="fas fa-moon"></i>;
            case "cloudy_day":
            case "cloudy_night": return <i className="fas fa-cloud"></i>;
            case "light_rain_day":
            case "light_rain_night": return <i className="fas fa-cloud-rain"></i>;
            case "heavy_rain_day":
            case "heavy_rain_night": return <i className="fas fa-cloud-showers-heavy"></i>;
            case "snow_day":
            case "snow_night": return <i className="fas fa-snowflake"></i>;
            case "thunder_day":
            case "thunder_night": return <i className="fas fa-bolt"></i>;
            default: return <i className="fas fa-question"></i>;
          }
        }

        return (
          <div className="app">
            <div className="left">
              {output.glazewm && (
                <div className="workspaces">
                  {output.glazewm.currentWorkspaces.map((ws) => (
                    <button
                      key={ws.name}
                      className={`workspace ${ws.hasFocus && "focused"} ${
                        ws.isDisplayed && "displayed"
                      }`}
                      onClick={() =>
                        output.glazewm.runCommand(`focus --workspace ${ws.name}`)
                      }
                    >
                      {ws.displayName ?? ws.name}
                    </button>
                  ))}
                </div>
              )}
            </div>

            {/* NEW TIME WIDGET REPLACES OLD DATE */}
            <div className="center">
              <TimeWidget />
            </div>

            <div className="right">
              {output.glazewm && (
                <>
                  {output.glazewm.isPaused && (
                    <button
                      className="paused-button"
                      onClick={() =>
                        output.glazewm.runCommand("wm-toggle-pause")
                      }
                    >
                      PAUSED
                    </button>
                  )}

                  {output.glazewm.bindingModes.map((mode) => (
                    <button
                      key={mode.name}
                      className="binding-mode"
                      onClick={() =>
                        output.glazewm.runCommand(
                          `wm-disable-binding-mode --name ${mode.name}`
                        )
                      }
                    >
                      {mode.displayName ?? mode.name}
                    </button>
                  ))}

                  <button
                    className={`tiling-direction nf ${
                      output.glazewm.tilingDirection === "horizontal"
                        ? "nf-md-swap_horizontal"
                        : "nf-md-swap_vertical"
                    }`}
                    onClick={() =>
                      output.glazewm.runCommand("toggle-tiling-direction")
                    }
                  ></button>
                </>
              )}

              {output.network && (
                <div className="network">{getNetworkIcon(output.network)}</div>
              )}

              {output.memory && (
                <div className="memory">
                  <i className="nf nf-fae-chip"></i>
                  {Math.round(output.memory.usage)}%
                </div>
              )}

              {output.cpu && (
                <div className="cpu">
                  <i className="nf nf-oct-cpu"></i>
                  <span className={output.cpu.usage > 85 ? "high-usage" : ""}>
                    {Math.round(output.cpu.usage)}%
                  </span>
                </div>
              )}

              {output.battery && (
                <div className="battery">
                  {output.battery.isCharging && (
                    <i className="nf nf-md-power_plug charging-icon"></i>
                  )}
                  {getBatteryIcon(output.battery)}
                  {Math.round(output.battery.chargePercent)}%
                </div>
              )}

              {output.weather && (
                <div className="weather">
                  {getWeatherIcon(output.weather)}
                  {Math.round(output.weather.fahrenheitTemp)}Â°F
                </div>
              )}
            </div>
          </div>
        );
      }

      createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>

